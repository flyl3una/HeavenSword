#! env/bin/python
# coding:utf-8
import os
import subprocess

import MySQLdb

from core.config import EXP_PATH, DB_HOST, DB_CHARSET, DB_PORT, DB_USER, DB_PASSWORD, DB_NAME
from core.function import get_domain


class ExploitAttack:

    __exp_files = None

    def __init__(self, target_host, cat):
        self.__target_host = target_host
        self.__cat = cat

    def attack(self):
        pass

    def has_exp(self):
        path = os.path.join(EXP_PATH, self.__cat.lower())
        # for rt, dirs, files in os.walk(path):
        files = []
        for file in os.listdir(path):
            # print file
            files.append(path + os.sep + file)
        if not files:
            self.__exp_files = None
            return False
        else:
            self.__exp_files = files
            return True

    def exploit(self):
        if self.__exp_files is None:
            print'没有找到exp'
            return
        for file in self.__exp_files:
            # result = os.popen('python ' + file)
            charset = 'utf-8'
            p = subprocess.Popen('python ' + file, shell=True, stdout=subprocess.PIPE)
            out, err = p.communicate()
            # print 'output:'
            output = out.decode(charset)
            # print 'error:'
            error = str(err).decode(charset)
            if output.index(u"Success!") != -1:
                print '[success]'
            else:
                print '[fails]'
            # for line in out.splitlines():
            #     print line

        # print result


def new_exploit_attack(task_id, url, app_type):
    app_type = 'drupal'
    domain = get_domain(url)
    conn = MySQLdb.connect(host=DB_HOST, port=DB_PORT, user=DB_USER, passwd=DB_PASSWORD, db=DB_NAME, charset=DB_CHARSET)
    cursor = conn.cursor()
    # 没写完
    sql = 'select * from apptype WHERE domain="%s"' % domain
    cursor.execute(sql)
    apps = cursor.fetchall()
    exploit_attack = ExploitAttack(url, app_type)
    if exploit_attack.has_exp():
        exploit_attack.exploit()

if __name__ == '__main__':
    exploit_attack = ExploitAttack('http://localhost/drupal-7.31/', 'drupal')
    if exploit_attack.has_exp():
        exploit_attack.exploit()